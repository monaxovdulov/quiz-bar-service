# CODE_STYLE.md — стиль кода для этого репозитория

Этот документ описывает правила, которых ДОЛЖЕН придерживаться любой агент (включая Codex CLI), пишущий код в этом репозитории.

Правила применяются ко ВСЕМ `*.py` файлам.

---

## 1. Общие принципы

- Пишем **простой, читаемый Python**, без переусложнения.
- Любой новый код должен ощущаться «нативным» к существующему — по стилю, именам, архитектуре.

---

## 2. Импорты и структура модулей

### 2.1. Абсолютные импорты

- **ВСЕГДА** используй **абсолютные импорты**:

  ```python
  from barquiz.utils.http_client import fetch_urls
```

а не относительные вида:

```python
from ..services.quiz_service import QuizService  # так НЕЛЬЗЯ
```

* Абсолютный импорт = полный путь от корня пакета или `site-packages`.

### 2.2. Порядок импортов

В каждом модуле:

1. Стандартная библиотека.
2. Сторонние библиотеки.
3. Локальные модули

Внутри каждой группы — сортировка по алфавиту.


### 2.3. Запреты и нюансы

* **НЕ ИСПОЛЬЗОВАТЬ**:

  ```python
  from __future__ import annotations
  ```

* Для forward-типов:

  ```python
  from typing import TYPE_CHECKING

  if TYPE_CHECKING:
      from logging import Logger
  
  ```

  и аннотации только в кавычках:

  ```python
  def foo(logger: "Logger") -> None:
      ...
  ```

* **НЕ** использовать:

  ```python
  from module import *
  ```

* Не допускай циклических импортов. Если они возникают — это сигнал, что нужно переразбить модули (вынести общие части в третий модуль).

### 2.4. Логика в `__init__.py`

* В `__init__.py` **НЕТ** бизнес-логики.
* Там допускаются только:

  * импорты для удобного API пакета;
  * константы.
* Никаких побочных эффектов при импорте.

---

## 3. Строгая типизация (STRONG TYPING RULES)

### 3.1. Всегда добавляй типы

* У ВСЕХ функций/методов:

  * все аргументы должны быть с type hints;
  * возвращаемое значение **всегда** аннотировано:

  ```python
  def get_variant(self, variant_id: str) -> Variant | None:
      ...
  ```

* Для переменных с неочевидным типом тоже желательно указывать тип:

  ```python
  attempts: list[Attempt] = []
  ```

### 3.2. Используй новые синтаксисы

* Встроенные generics:

  * `list`, `dict`, `set`, `tuple`
    вместо `List`, `Dict`, `Set`, `Tuple`.

* Объединения:

  * `type1 | type2` вместо `Union[type1, type2]`.
  * `type | None` вместо `Optional[type]`.

### 3.3. Any, алиасы и спецтипы

* `Any` — **крайняя мера**, избегать по максимуму.

* Для сложных типов заводи алиасы:

  ```python
  from typing import TypeAlias

  UserId: TypeAlias = int
  ```

* Константы:

  * Используй `Final[...]` и неизменяемые структуры (кортеж, `MappingProxyType`), а не список/словарь.

* Классовые поля:

  * Используй `ClassVar[...]` для значений, общих для всех экземпляров.

* Методы, возвращающие экземпляр своего класса, могут использовать `Self` (если уместно).

---

## 4. Стиль кода

### 4.1. Строки и коллекции

* Строки форматировать **только через f-strings**:

  ```python
  message = f"Variant {variant_id} not found for user {user_id}"
  ```

* Для построения списков/словарей отдавай предпочтение comprehensions:

  ```python
  user_ids = [attempt.user_id for attempt in attempts]
  ```

### 4.2. Работа с ресурсами

* Для файлов, сетевых соединений и т.п. — всегда `with`:

  ```python
  with path.open("r", encoding="utf-8") as file:
      data = json.load(file)
  ```

### 4.3. Структура и вложенность

* Избегай глубокой вложенности `if`/`for`/`try`.
* Предпочитай:

  * ранние `return`/`continue`/`break`;
  * вынос сложных кусочков в отдельные функции/методы.

### 4.4. Константы и перечисления

* Для наборов родственных констант используй `Enum`/`StrEnum`/`IntEnum`, а не голые строки/числа.
* Для временных зон используй `datetime.UTC`, а не `timezone.utc`.

### 4.5. Статические методы

* **НЕ** используй `@staticmethod`.
* Если нужен «утилитарный» метод:

  * либо сделай его свободной функцией;
  * либо используй `@classmethod`, если он логически относится к классу.

---

## 5. Docstring-и и комментарии

### 5.1. Docstring-и

* У всех **публичных** классов и функций должны быть docstrings в стиле **Google**:

  ```python
  def check_answer(self, ...) -> Attempt:
      """Check user answer and create an Attempt.

      Args:
          user_id: Telegram user id.
          task: Task object to check.
          variant_id: Variant id or None.
          raw_input: Raw text from user.

      Returns:
          Attempt object with is_correct flag and timestamp.
      """
  ```

* Для приватных функций/методов docstring по ситуации: где нужно пояснить неочевидную логику.

### 5.2. Комментарии

* Не комментируй очевидное.
* Если без комментария сложно понять «почему именно так» — короткий, по делу комментарий допустим.
* Не используем комментарии как костыль вместо нормальной структуры кода.

---

## 6. Обработка ошибок

* `try/except` должен быть **минимально широким**, только вокруг потенциально падающих операций.

* Не использовать голый `except:` и не ловить `BaseException`.

* Избегать широкого `except Exception:` без необходимости.

* Проверяй входные данные и валидацию через явное:

  * `ValueError` — неправильные значения;
  * `TypeError` — неправильные типы.

* Для логирования с трассировкой:

  ```python
  logger.exception("Failed to load questions from %s", path)
  ```

---

## 7. Особенности этого проекта


## 8. Управление зависимостями и запуск

uv

---

## 9. Итоговое правило

> ВСЕ НОВЫЕ И ИЗМЕНЁННЫЕ КУСОЧКИ КОДА ДОЛЖНЫ СООТВЕТСТВОВАТЬ ЭТИМ ПРАВИЛАМ, ДАЖЕ ЕСЛИ СТАРЫЙ КОД ИХ НАРУШАЕТ.

Если приходится выбирать между:

* «быстро зафигачить кое-как» и
* «чуть-чуть дольше, но по правилам» —

всегда выбираем второй вариант.

